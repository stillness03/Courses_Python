{% extends "admin_panel/base.html" %}
{% block title %}Courses - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Courses</h2>
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createCourseModal">+ Add Course</button>
</div>

<!-- Table with courses -->
<table class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Type</th>
      <th>Price</th>
      <th>Duration (months)</th>
      <th>Tags</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="courses-table-body"></tbody>
</table>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>ForPageCourse</h2>
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createFPCModal">+ Add ForPageCourse</button>
</div>

<!-- Table with ForPageCourse -->
<table class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Course</th>
      <th>Fun Fact</th>
      <th>Projects</th>
    </tr>
  </thead>
  <tbody id="fpc-table-body"></tbody>
</table>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>FAQ</h2>
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createFAQModal">+ Add FAQ</button>
</div>

<!-- Table with FAQ -->
<table class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Course</th>
      <th>Question</th>
      <th>Answer</th>
    </tr>
  </thead>
  <tbody id="faq-table-body"></tbody>
</table>


<!-- Modal for creating course -->
<div class="modal fade" id="createCourseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="createCourseForm">
        <div class="modal-header">
          <h5 class="modal-title">Create Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Title *</label>
            <input type="text" class="form-control" name="title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description *</label>
            <textarea class="form-control" name="description" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Type *</label>
            <select class="form-control" name="type_course" required>
              <option value="standard">Standard</option>
              <option value="premium">Premium</option>
              <option value="intensive">Intensive</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Tags *</label>
            <input type="text" class="form-control" name="tags" required placeholder="e.g., python, web development, django">
            <div class="form-text">Separate tags with commas</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Price *</label>
            <input type="number" step="0.01" class="form-control" name="price" required min="0">
          </div>
          <div class="mb-3">
            <label class="form-label">Duration (months) *</label>
            <input type="number" class="form-control" name="duration" required min="1" placeholder="e.g., 3">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Course</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ForPageCourse Modal -->
<div class="modal fade" id="createFPCModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="createFPCForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create ForPageCourse</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="fpcCourse">Course</label>
          <select name="course" id="fpcCourse" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label>Fun fact</label>
          <input type="text" name="fun_fact" class="form-control" required>
        </div>
        <div class="mb-3">
          <label>Projects</label>
          <input type="number" name="projects" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- FAQ Modal -->
<div class="modal fade" id="createFAQModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="createFAQForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create FAQ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="faqCourse">Course</label>
          <select name="course" id="faqCourse" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label>Question</label>
          <input type="text" name="question" class="form-control" required>
        </div>
        <div class="mb-3">
          <label>Answer</label>
          <textarea name="answer" class="form-control" required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
// CSRF token for Django
const CSRF_TOKEN = "{{ csrf_token }}";

// Load courses
async function loadCourses() {
  try {
    const response = await fetch("/api/courses/");
    if (!response.ok) {
      throw new Error('Failed to fetch courses');
    }
    const data = await response.json();
    const tbody = document.getElementById("courses-table-body");
    tbody.innerHTML = "";
    
    data.forEach(course => {
      const row = `
        <tr>
          <td>${course.id}</td>
          <td>${course.title}</td>
          <td><span class="badge bg-primary">${course.type_course}</span></td>
          <td>$${parseFloat(course.price).toFixed(2)}</td>
          <td>${course.duration} months</td>
          <td>${course.tags}</td>
          <td>${new Date(course.created_at).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editCourse(${course.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCourse(${course.id})">Delete</button>
          </td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  } catch (error) {
    console.error('Error loading courses:', error);
    alert('Error loading courses: ' + error.message);
  }
}

async function populateCourseSelect(selectId) {
  try {
    const response = await fetch("/api/courses/");
    if (!response.ok) throw new Error("Failed to fetch courses");
    const courses = await response.json();

    const select = document.getElementById(selectId);
    select.innerHTML = "<option value='' disabled selected>Choose course</option>";
    courses.forEach(c => {
      select.insertAdjacentHTML("beforeend",
        `<option value="${c.id}">${c.title}</option>`);
    });
  } catch (err) {
    console.error("Error loading courses for select:", err);
  }
}

// Load FAQ
async function loadFAQs() {
  const res = await fetch("/api/faqs/");
  const data = await res.json();
  const tbody = document.getElementById("faq-table-body");
  tbody.innerHTML = "";
  data.forEach(f => {
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${f.id}</td>
        <td>${f.course || "—"}</td>
        <td>${f.question}</td>
        <td>${f.answer}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="editFAQ(${f.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteFAQ(${f.id})">Delete</button>
        </td>
      </tr>
    `);
  });
}

// Load FPC
async function loadFPC() {
  const res = await fetch("/api/forpagecourses/");
  const data = await res.json();
  const tbody = document.getElementById("fpc-table-body");
  tbody.innerHTML = "";
  data.forEach(fpc => {
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${fpc.id}</td>
        <td>${fpc.course || "—"}</td>
        <td>${fpc.fun_fact}</td>
        <td>${fpc.projects}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="editFPC(${fpc.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteFPC(${fpc.id})">Delete</button>
        </td>
      </tr>
    `);
  });
}

// Handle create form
document.getElementById("createCourseForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const body = {
    title: formData.get('title'),
    description: formData.get('description'),
    type_course: formData.get('type_course'),
    tags: formData.get('tags'),
    price: parseFloat(formData.get('price')),
    duration: parseInt(formData.get('duration'))
  };

  // Validation
  if (body.duration < 1) {
    alert('Duration must be at least 1 month');
    return;
  }

  if (body.price < 0) {
    alert('Price cannot be negative');
    return;
  }

  try {
    const response = await fetch("/api/courses/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF_TOKEN
      },
      body: JSON.stringify(body)
    });

    if (response.ok) {
      this.reset();
      bootstrap.Modal.getInstance(document.getElementById("createCourseModal")).hide();
      loadCourses();
      alert('Course created successfully!');
    } else {
      const errorData = await response.json();
      alert("Error creating course: " + (errorData.detail || JSON.stringify(errorData)));
    }
  } catch (error) {
    console.error('Error:', error);
    alert("Error creating course: " + error.message);
  }
});


// Create FAQ
document.getElementById("createFAQForm").addEventListener("submit", async e => {
  e.preventDefault();
  const form = new FormData(e.target);
  await fetch("/api/faqs/", {
    method: "POST",
    headers: {"X-CSRFToken": CSRF_TOKEN},
    body: form
  });
  bootstrap.Modal.getInstance(document.getElementById("createFAQModal")).hide();
  loadFAQs();
});

// Create FPC
document.getElementById("createFPCForm").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);

  const body = {
    course: parseInt(formData.get("course")),
    fun_fact: formData.get("fun_fact"),
    projects: parseInt(formData.get("projects"))
  };

  try {
    const res = await fetch("/api/forpagecourses/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF_TOKEN
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const err = await res.json();
      console.error("Error:", err);
      alert("Erorr when u try created ForPageCourse: " + JSON.stringify(err));
      return;
    }

    bootstrap.Modal.getInstance(document.getElementById("createFPCModal")).hide();
    e.target.reset();
    loadFPC();
  } catch (error) {
    console.error("Error:", error);
    alert("Error with conection: " + error.message);
  }
});

// Edit course function
function editCourse(courseId) {
  alert('Edit functionality for course ' + courseId + ' will be implemented here');
  // Implement edit functionality
}

// Delete course function
async function deleteCourse(courseId) {
  if (confirm('Are you sure you want to delete this course?')) {
    try {
      const response = await fetch(`/api/courses/${courseId}/`, {
        method: "DELETE",
        headers: {
          "X-CSRFToken": CSRF_TOKEN
        }
      });

      if (response.ok) {
        loadCourses();
        alert('Course deleted successfully!');
      } else {
        alert('Error deleting course');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error deleting course: ' + error.message);
    }
  }
}

async function deleteFAQ(id) {
  await fetch(`/api/faqs/${id}/`, {
    method: "DELETE",
    headers: {"X-CSRFToken": CSRF_TOKEN}
  });
  loadFAQs();
}

async function deleteFPC(id) {
  await fetch(`/api/forpagecourses/${id}/`, {
    method: "DELETE",
    headers: {"X-CSRFToken": CSRF_TOKEN}
  });
  loadFPC();
}



// Load courses on page load
document.addEventListener("DOMContentLoaded", function() {
  loadCourses();
  loadFAQs();
  loadFPC();

  document.getElementById("createFAQModal")
    .addEventListener("show.bs.modal", () => populateCourseSelect("faqCourse"));

  document.getElementById("createFPCModal")
    .addEventListener("show.bs.modal", () => populateCourseSelect("fpcCourse"));
});
</script>

{% endblock %}