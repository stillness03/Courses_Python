{% extends "admin_panel/base.html" %}
{% block title %}Courses - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Courses</h2>
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createCourseModal">+ Add Course</button>
</div>

<!-- Table with courses -->
<table class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Type</th>
      <th>Price</th>
      <th>Duration (months)</th>
      <th>Tags</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="courses-table-body">
  </tbody>
</table>

<!-- Modal for creating course -->
<div class="modal fade" id="createCourseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="createCourseForm">
        <div class="modal-header">
          <h5 class="modal-title">Create Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Title *</label>
            <input type="text" class="form-control" name="title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description *</label>
            <textarea class="form-control" name="description" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Type *</label>
            <select class="form-control" name="type_course" required>
              <option value="standard">Standard</option>
              <option value="premium">Premium</option>
              <option value="intensive">Intensive</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Tags *</label>
            <input type="text" class="form-control" name="tags" required placeholder="e.g., python, web development, django">
            <div class="form-text">Separate tags with commas</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Price *</label>
            <input type="number" step="0.01" class="form-control" name="price" required min="0">
          </div>
          <div class="mb-3">
            <label class="form-label">Duration (months) *</label>
            <input type="number" class="form-control" name="duration" required min="1" placeholder="e.g., 3">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Course</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// CSRF token for Django
const CSRF_TOKEN = "{{ csrf_token }}";

// Load courses
async function loadCourses() {
  try {
    const response = await fetch("/api/courses/");
    if (!response.ok) {
      throw new Error('Failed to fetch courses');
    }
    const data = await response.json();
    const tbody = document.getElementById("courses-table-body");
    tbody.innerHTML = "";
    
    data.forEach(course => {
      const row = `
        <tr>
          <td>${course.id}</td>
          <td>${course.title}</td>
          <td><span class="badge bg-primary">${course.type_course}</span></td>
          <td>$${parseFloat(course.price).toFixed(2)}</td>
          <td>${course.duration} months</td>
          <td>${course.tags}</td>
          <td>${new Date(course.created_at).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editCourse(${course.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCourse(${course.id})">Delete</button>
          </td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  } catch (error) {
    console.error('Error loading courses:', error);
    alert('Error loading courses: ' + error.message);
  }
}

// Handle create form
document.getElementById("createCourseForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const body = {
    title: formData.get('title'),
    description: formData.get('description'),
    type_course: formData.get('type_course'),
    tags: formData.get('tags'),
    price: parseFloat(formData.get('price')),
    duration: parseInt(formData.get('duration'))
  };

  // Validation
  if (body.duration < 1) {
    alert('Duration must be at least 1 month');
    return;
  }

  if (body.price < 0) {
    alert('Price cannot be negative');
    return;
  }

  try {
    const response = await fetch("/api/courses/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF_TOKEN
      },
      body: JSON.stringify(body)
    });

    if (response.ok) {
      this.reset();
      bootstrap.Modal.getInstance(document.getElementById("createCourseModal")).hide();
      loadCourses();
      alert('Course created successfully!');
    } else {
      const errorData = await response.json();
      alert("Error creating course: " + (errorData.detail || JSON.stringify(errorData)));
    }
  } catch (error) {
    console.error('Error:', error);
    alert("Error creating course: " + error.message);
  }
});

// Edit course function
function editCourse(courseId) {
  alert('Edit functionality for course ' + courseId + ' will be implemented here');
  // Implement edit functionality
}

// Delete course function
async function deleteCourse(courseId) {
  if (confirm('Are you sure you want to delete this course?')) {
    try {
      const response = await fetch(`/api/courses/${courseId}/`, {
        method: "DELETE",
        headers: {
          "X-CSRFToken": CSRF_TOKEN
        }
      });

      if (response.ok) {
        loadCourses();
        alert('Course deleted successfully!');
      } else {
        alert('Error deleting course');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error deleting course: ' + error.message);
    }
  }
}

// Load courses on page load
document.addEventListener("DOMContentLoaded", function() {
  loadCourses();
});
</script>

{% endblock %}