{% extends "admin_panel/base.html" %}
{% block title %}Lessons{% endblock %}

{% block content %}
<div class="page-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="page-title">Lessons</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createLessonModal">+ Add Lesson</button>
  </div>

  <!-- Table Lessons-->
 <div class="page-table"></div>
  <table class="table">
    <thead class="table-header">
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Course</th>
        <th>Topic</th>
        <th>Created</th>
      </tr>
    </thead>
      <tbody id="lessons-table">
        <tr class="loading-row">
            <td colspan="6"></td>
          </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal for created -->
  <div class="modal fade" id="createLessonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Lesson</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="create-lesson-form">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" name="title" required placeholder="Enter lesson title">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Course *</label>
                <select class="form-select" name="course" id="course-select" required>
                  <option value="">Select a course</option>
                </select>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Topic *</label>
              <select class="form-select" name="topic" id="topic" required>
                <option value="">Select a topic</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Content</label>
              <textarea class="form-control" name="content" rows="4" placeholder="Enter lesson content"></textarea>
            </div>
            
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Create Lesson</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  loadLessons();
  loadCourses();
  loadTopics();

  // Load lessons into table
  function loadLessons() {
    fetch("/api/lessons/")
      .then(res => res.json())
      .then(data => {
        const table = document.getElementById("lessons-table");
        table.innerHTML = "";
        data.forEach(lesson => {
          table.innerHTML += `
            <tr>
              <td>${lesson.id}</td>
              <td>${lesson.title}</td>
              <td>${lesson.course || "—"}</td>
              <td>${lesson.topic || "—"}</td>
              <td>${new Date(lesson.created_at).toLocaleDateString()}</td>
              <td>
                <button class="btn btn-sm btn-warning me-1" onclick="editLesson(${lesson.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteLesson(${lesson.id})">Delete</button>
              </td>
            </tr>
          `;
        });
      });
  }

  // Load courses into select
  function loadCourses() {
    fetch("/api/courses/")
      .then(res => res.json())
      .then(courses => {
        const select = document.getElementById("course-select");
        select.innerHTML = "";
        courses.forEach(course => {
          select.innerHTML += `<option value="${course.id}">${course.title}</option>`;
        });
      });
  }

  // Load topics into select
  function loadTopics() {
    fetch("/api/topics/")
      .then(res => res.json())
      .then(topics => {
        const select = document.getElementById("topic");
        select.innerHTML = "";
        topics.forEach(topic => {
          select.innerHTML += `<option value="${topic.id}">${topic.title}</option>`;
        });
      });
  }

  // Create lesson
  document.getElementById("create-lesson-form").addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const payload = Object.fromEntries(formData.entries());

    fetch("/api/lessons/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": window.CSRF_TOKEN
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (!res.ok) throw new Error("Failed to create lesson");
      return res.json();
    })
    .then(() => {
      this.reset();
      loadLessons();
      bootstrap.Modal.getInstance(document.getElementById("createLessonModal")).hide();
    })
    .catch(err => alert(err));
  });
});

function editLesson(id) {
  const newTitle = prompt("Enter new title for the lesson:");
  if (!newTitle) return;

  fetch(`/api/lessons/${id}/`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": window.CSRF_TOKEN
    },
    body: JSON.stringify({ title: newTitle })
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to update lesson");
    loadLessons();
  })
  .catch(err => alert(err));
}

function deleteLesson(id) {
  if (!confirm("Are you sure you want to delete this lesson?")) return;
  fetch(`/api/lessons/${id}/`, {
    method: "DELETE",
    headers: {
      "X-CSRFToken": window.CSRF_TOKEN
    }
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to delete lesson");
    loadLessons();
  })
  .catch(err => alert(err));
}

</script>
{% endblock %}
